'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { toast } from 'react-hot-toast';
import { communicationApi, Message, CommunicationChannel } from '@/lib/api/communication';
import { emailRulesApi, EmailCategory } from '@/lib/api/emailRules';
import MessageAnalysisReport from '@/components/MessageAnalysisReport';

export default function CommunicationPage() {
  const [channels, setChannels] = useState<CommunicationChannel[]>([]);
  const [messages, setMessages] = useState<Message[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedFilter, setSelectedFilter] = useState<'all' | 'unread' | 'action-needed' | 'processed'>('all');
  const [showChannelModal, setShowChannelModal] = useState(false);
  const [selectedMessage, setSelectedMessage] = useState<Message | null>(null);
  const [channelFilter, setChannelFilter] = useState<string>('all');
  const [lastRefresh, setLastRefresh] = useState<Date | null>(null);
  
  // Edit & Reply states
  const [editingMessage, setEditingMessage] = useState<Message | null>(null);
  const [replyingToMessage, setReplyingToMessage] = useState<Message | null>(null);
  const [forwardingMessage, setForwardingMessage] = useState<Message | null>(null);
  const [editContent, setEditContent] = useState('');
  const [editSubject, setEditSubject] = useState('');
  const [replyContent, setReplyContent] = useState('');
  const [replySubject, setReplySubject] = useState('');
  const [replyToAddress, setReplyToAddress] = useState('');
  const [forwardToAddresses, setForwardToAddresses] = useState<string[]>(['']);
  const [forwardContent, setForwardContent] = useState('');
  
  // GTD Processing states
  const [showGTDModal, setShowGTDModal] = useState(false);
  const [gtdProcessingMessage, setGTDProcessingMessage] = useState<Message | null>(null);
  const [gtdDecision, setGTDDecision] = useState<'DO' | 'DEFER' | 'DELEGATE' | 'DELETE' | 'REFERENCE' | 'PROJECT' | 'SOMEDAY'>('DO');
  const [gtdTaskTitle, setGTDTaskTitle] = useState('');
  const [gtdContext, setGTDContext] = useState('@computer');
  const [gtdPriority, setGTDPriority] = useState<'LOW' | 'MEDIUM' | 'HIGH'>('MEDIUM');
  const [gtdDueDate, setGTDDueDate] = useState('');
  const [gtdEstimatedTime, setGTDEstimatedTime] = useState<number>(30);
  const [gtdDelegateUser, setGTDDelegateUser] = useState('');
  const [gtdProjectTitle, setGTDProjectTitle] = useState('');
  const [gtdNote, setGTDNote] = useState('');
  
  // Dodatkowe pola GTD dla pe≈Çnej funkcjonalno≈õci
  const [gtdEnergyLevel, setGTDEnergyLevel] = useState<'LOW' | 'MEDIUM' | 'HIGH'>('MEDIUM');
  const [gtdTags, setGTDTags] = useState<string[]>([]);
  const [gtdStreamId, setGTDStreamId] = useState('');
  const [gtdProjectId, setGTDProjectId] = useState('');
  const [gtdAssignedToId, setGTDAssignedToId] = useState('');
  const [gtdIsWaitingFor, setGTDIsWaitingFor] = useState(false);
  const [gtdWaitingForNote, setGTDWaitingForNote] = useState('');
  
  // Pola specyficzne dla PROJECT
  const [gtdProjectPriority, setGTDProjectPriority] = useState<'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'>('MEDIUM');
  const [gtdProjectStatus, setGTDProjectStatus] = useState<'PLANNING' | 'IN_PROGRESS' | 'ON_HOLD' | 'COMPLETED' | 'CANCELED'>('PLANNING');
  const [gtdStartDate, setGTDStartDate] = useState('');
  const [gtdEndDate, setGTDEndDate] = useState('');
  const [gtdProjectDescription, setGTDProjectDescription] = useState('');
  
  // Pola specyficzne dla SOMEDAY
  const [gtdSomedayCategory, setGTDSomedayCategory] = useState<'IDEAS' | 'PROJECTS' | 'GOALS' | 'LEARNING' | 'TRAVEL' | 'PURCHASES' | 'EXPERIENCES'>('IDEAS');
  const [gtdSomedayWhenToReview, setGTDSomedayWhenToReview] = useState('');
  
  // Pola specyficzne dla REFERENCE
  const [gtdReferenceCategory, setGTDReferenceCategory] = useState('');
  const [gtdReferenceUrl, setGTDReferenceUrl] = useState('');
  
  // Mail client features
  const [selectedMessages, setSelectedMessages] = useState<Set<string>>(new Set());
  const [selectAll, setSelectAll] = useState(false);
  const [showBulkActions, setShowBulkActions] = useState(false);
  const [showRuleSelector, setShowRuleSelector] = useState(false);
  const [availableRules, setAvailableRules] = useState<any[]>([]);
  const [selectedRule, setSelectedRule] = useState<string>('');
  const [ruleApplication, setRuleApplication] = useState<'once' | 'always'>('once');
  const [previewMessage, setPreviewMessage] = useState<Message | null>(null);
  const [layout, setLayout] = useState<'list' | 'preview'>('list');
  
  // AI Analysis control
  const [analyzingMessages, setAnalyzingMessages] = useState<Set<string>>(new Set());
  const [bulkAnalysisInProgress, setBulkAnalysisInProgress] = useState(false);
  const bulkAnalysisTimeouts = useRef<NodeJS.Timeout[]>([]);

  // Quick Email Filtering states
  const [showQuickFilterModal, setShowQuickFilterModal] = useState(false);
  const [quickFilterMessage, setQuickFilterMessage] = useState<Message | null>(null);
  const [quickFilterCategory, setQuickFilterCategory] = useState<EmailCategory>('UNKNOWN');
  const [quickFilterCreateRule, setQuickFilterCreateRule] = useState(false);
  const [quickFilterRuleName, setQuickFilterRuleName] = useState('');

  // Funkcja filtrowania wiadomo≈õci
  const getFilteredMessages = () => {
    let filteredMessages = messages;

    // Filtruj wed≈Çug typu filtru
    switch (selectedFilter) {
      case 'unread':
        filteredMessages = filteredMessages.filter(msg => !msg.isRead);
        break;
      case 'action-needed':
        filteredMessages = filteredMessages.filter(msg => msg.actionNeeded);
        break;
      case 'processed':
        filteredMessages = filteredMessages.filter(msg => msg.taskId);
        break;
      default: // 'all'
        break;
    }

    // Filtruj wed≈Çug kana≈Çu
    if (channelFilter !== 'all') {
      filteredMessages = filteredMessages.filter(msg => msg.channelId === channelFilter);
    }

    return filteredMessages;
  };

  useEffect(() => {
    loadCommunicationData();
  }, []); // Empty dependency array to run only once on mount

  useEffect(() => {
    // Keyboard shortcut for AI analysis (Ctrl/Cmd + A)
    const handleKeyboard = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'a' && selectedMessage) {
        e.preventDefault();
        handleAnalyzeWithAI(selectedMessage.id);
      }
    };

    window.addEventListener('keydown', handleKeyboard);

    return () => {
      window.removeEventListener('keydown', handleKeyboard);
    };
  }, [selectedMessage]); // Only depends on selectedMessage for keyboard shortcuts

  // Ponowne ≈Çadowanie gdy zmieni siƒô filtr
  useEffect(() => {
    // Nie trzeba ponownie ≈Çadowaƒá z serwera - po prostu filtrujemy lokalne dane
  }, [selectedFilter, channelFilter]);

  // Cleanup function to cancel bulk analysis timeouts on component unmount
  useEffect(() => {
    return () => {
      // Clear all pending timeouts when component unmounts
      bulkAnalysisTimeouts.current.forEach(timeout => clearTimeout(timeout));
      bulkAnalysisTimeouts.current = [];
    };
  }, []);

  const loadCommunicationData = async () => {
    try {
      setLoading(true);
      
      console.log('Loading communication data...');
      
      const [channelsResponse, messagesResponse, rulesResponse] = await Promise.all([
        communicationApi.getChannels().catch(err => {
          console.error('Error loading channels:', err);
          return [];
        }),
        communicationApi.getMessages({
          isRead: selectedFilter === 'unread' ? false : undefined,
          actionNeeded: selectedFilter === 'action-needed' ? true : undefined,
          processed: selectedFilter === 'processed' ? true : undefined,
          limit: 100
        }).catch(err => {
          console.error('Error loading messages:', err);
          return [];
        }),
        // Load available processing rules
        communicationApi.getProcessingRules().catch(err => {
          console.error('Error loading processing rules:', err);
          return [];
        })
      ]);
      
      console.log('Channels response:', channelsResponse);
      console.log('Messages response:', messagesResponse);
      console.log('Channels for message mapping:', channelsResponse.map(ch => ({ id: ch.id, name: ch.name })));

      // Add mock unread counts for display (until we have real message counting)
      const channelsWithCounts = channelsResponse.map((channel: any) => ({
        ...channel,
        unreadCount: channel._count?.messages || 0,
        lastMessage: 'Ostatnia wiadomo≈õƒá...',
        lastMessageAt: new Date(Date.now() - Math.random() * 86400000).toISOString()
      }));

      setChannels(channelsWithCounts);
      setMessages(messagesResponse);
      setAvailableRules(rulesResponse);
      setLastRefresh(new Date());
    } catch (error) {
      setChannels([]);
      setMessages([]);
      setAvailableRules([]);
      toast.error('Failed to load communication data', { id: 'load-error' });
    } finally {
      setLoading(false);
      setLastRefresh(new Date());
    }
  };

  // Mail selection functions
  const handleSelectMessage = (messageId: string) => {
    const newSelected = new Set(selectedMessages);
    if (newSelected.has(messageId)) {
      newSelected.delete(messageId);
    } else {
      newSelected.add(messageId);
    }
    setSelectedMessages(newSelected);
    setShowBulkActions(newSelected.size > 0);
  };

  const handleSelectAll = () => {
    const filteredMessages = getFilteredMessages();
    if (selectAll) {
      setSelectedMessages(new Set());
      setShowBulkActions(false);
    } else {
      setSelectedMessages(new Set(filteredMessages.map(m => m.id)));
      setShowBulkActions(filteredMessages.length > 0);
    }
    setSelectAll(!selectAll);
  };

  const handleBulkMarkAsRead = async () => {
    try {
      const messageIds = Array.from(selectedMessages);
      // Implementation would go here
      toast.success(`Oznaczono ${messageIds.length} wiadomo≈õci jako przeczytane`);
      setSelectedMessages(new Set());
      setShowBulkActions(false);
      setSelectAll(false);
    } catch (error) {
      toast.error('B≈ÇƒÖd podczas oznaczania wiadomo≈õci');
    }
  };

  const handleBulkDelete = async () => {
    if (!confirm(`Czy na pewno chcesz usunƒÖƒá ${selectedMessages.size} wiadomo≈õci?`)) return;
    
    try {
      const messageIds = Array.from(selectedMessages);
      // Implementation would go here
      toast.success(`Usuniƒôto ${messageIds.length} wiadomo≈õci`);
      setSelectedMessages(new Set());
      setShowBulkActions(false);
      setSelectAll(false);
      loadCommunicationData();
    } catch (error) {
      toast.error('B≈ÇƒÖd podczas usuwania wiadomo≈õci');
    }
  };

  const handleApplyRule = async () => {
    if (!selectedRule) {
      toast.error('Wybierz regu≈Çƒô do zastosowania');
      return;
    }

    try {
      const messageIds = Array.from(selectedMessages);
      const rule = availableRules.find(r => r.id === selectedRule);
      
      // Apply rule to selected messages
      const response = await fetch('/crm/api/v1/communication/bulk-apply-rule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          messageIds,
          ruleId: selectedRule,
          mode: ruleApplication,
          createPermanentRule: ruleApplication === 'always'
        })
      });

      if (response.ok) {
        const result = await response.json();
        toast.success(`Zastosowano regu≈Çƒô \"${rule?.name}\" do ${messageIds.length} wiadomo≈õci`);
        
        if (ruleApplication === 'always') {
          toast('Regu≈Ça bƒôdzie automatycznie stosowana do przysz≈Çych wiadomo≈õci', { icon: '‚ÑπÔ∏è' });
        }
        
        setSelectedMessages(new Set());
        setShowBulkActions(false);
        setShowRuleSelector(false);
        setSelectAll(false);
        loadCommunicationData();
      } else {
        throw new Error('Failed to apply rule');
      }
    } catch (error) {
      toast.error('B≈ÇƒÖd podczas stosowania regu≈Çy');
    }
  };

  const handleProcessMessage = async (messageId: string) => {
    // This would redirect to GTD Inbox for processing
    window.location.href = `/crm/dashboard/gtd/inbox?messageId=${messageId}`;
  };

  const handleMarkAsRead = async (messageId: string) => {
    try {
      await communicationApi.markAsRead(messageId);
      setMessages(messages.map(m => 
        m.id === messageId ? { ...m, isRead: true } : m
      ));
      toast.success('Message marked as read');
    } catch (error) {
      console.error('Error marking message as read:', error);
      toast.error('Failed to mark as read');
    }
  };

  const handleAnalyzeWithAI = useCallback(async (messageId: string) => {
    // Use a flag to check if we should proceed
    let shouldProceed = false;
    
    setAnalyzingMessages(prev => {
      if (prev.has(messageId)) {
        return prev; // Already analyzing, don't proceed
      }
      shouldProceed = true;
      return new Set([...prev, messageId]); // Add to analyzing set
    });

    if (!shouldProceed) {
      toast('Message is already being analyzed', { icon: '‚ÑπÔ∏è' });
      return;
    }

    try {
      toast.loading('Analyzing message with AI...', { id: `ai-analysis-${messageId}` });
      
      // Call AI analysis API using the proper API client
      const result = await communicationApi.analyzeMessage(messageId);
      
      // Update message with analysis results
      setMessages(prev => prev.map(m => {
        if (m.id === messageId) {
          return {
            ...m,
            urgencyScore: result.urgencyScore || m.urgencyScore,
            actionNeeded: result.actionNeeded !== undefined ? result.actionNeeded : m.actionNeeded,
          };
        }
        return m;
      }));

      // If AI found CRM connections, automatically log as activity
      if (result.contactId || result.companyId || result.dealId) {
        try {
          const activityResult = await communicationApi.linkMessageToCRM(messageId, {
            contactId: result.contactId,
            companyId: result.companyId,
            dealId: result.dealId
          });
          
          if (activityResult.success) {
            console.log('Communication activity logged successfully:', activityResult.activityId);
            toast.success('Communication logged to CRM timeline!');
          }
        } catch (error) {
          console.error('Failed to log communication activity:', error);
        }
      }

      toast.success('AI analysis completed!', { id: `ai-analysis-${messageId}` });
      
      // Show analysis results
      if (result.taskCreated) {
        toast.success(`Created task: ${result.taskTitle}`);
      }
      if (result.contactCreated) {
        toast.success(`Created contact: ${result.contactName}`);
      }
      if (result.dealCreated) {
        toast.success(`Created deal: ${result.dealTitle}`);
      }
      
    } catch (error) {
      console.error('Error analyzing message:', error);
      toast.error('Failed to analyze message', { id: `ai-analysis-${messageId}` });
    } finally {
      // Remove message from analyzing set
      setAnalyzingMessages(prev => {
        const newSet = new Set(prev);
        newSet.delete(messageId);
        return newSet;
      });
    }
  }, []); // Remove analyzingMessages from dependencies to prevent infinite loop

  // Edit Message Functions
  const handleEditMessage = (message: Message) => {
    setEditingMessage(message);
    setEditContent(message.content);
    setEditSubject(message.subject || '');
  };

  const handleSaveEdit = async () => {
    if (!editingMessage) return;
    
    try {
      toast.loading('Zapisywanie zmian...', { id: 'edit-message' });
      
      const updatedMessage = await communicationApi.updateMessage(editingMessage.id, {
        content: editContent,
        subject: editSubject
      });
      
      setMessages(messages.map(m => m.id === editingMessage.id ? updatedMessage : m));
      setEditingMessage(null);
      setEditContent('');
      setEditSubject('');
      
      toast.success('Wiadomo≈õƒá zaktualizowana', { id: 'edit-message' });
    } catch (error) {
      console.error('Error updating message:', error);
      toast.error('B≈ÇƒÖd podczas aktualizacji wiadomo≈õci', { id: 'edit-message' });
    }
  };

  const handleCancelEdit = () => {
    setEditingMessage(null);
    setEditContent('');
    setEditSubject('');
  };

  // Reply Functions
  const handleReplyToMessage = (message: Message) => {
    setReplyingToMessage(message);
    setReplyToAddress(message.fromAddress);
    setReplySubject(message.subject ? `Re: ${message.subject}` : 'Re: (bez tematu)');
    setReplyContent('');
  };

  const handleSendReply = async () => {
    if (!replyingToMessage) return;
    
    try {
      toast.loading('Wysy≈Çanie odpowiedzi...', { id: 'send-reply' });
      
      const result = await communicationApi.replyToMessage(replyingToMessage.id, {
        content: replyContent,
        subject: replySubject,
        toAddress: replyToAddress
      });
      
      if (result.success) {
        toast.success('Odpowied≈∫ wys≈Çana', { id: 'send-reply' });
        setReplyingToMessage(null);
        setReplyContent('');
        setReplySubject('');
        setReplyToAddress('');
        loadCommunicationData(); // Refresh messages
      } else {
        throw new Error('Failed to send reply');
      }
    } catch (error) {
      console.error('Error sending reply:', error);
      toast.error('B≈ÇƒÖd podczas wysy≈Çania odpowiedzi', { id: 'send-reply' });
    }
  };

  const handleCancelReply = () => {
    setReplyingToMessage(null);
    setReplyContent('');
    setReplySubject('');
    setReplyToAddress('');
  };

  // Forward Functions
  const handleForwardMessage = (message: Message) => {
    setForwardingMessage(message);
    setForwardToAddresses(['']);
    setForwardContent('');
  };

  const handleSendForward = async () => {
    if (!forwardingMessage) return;
    
    const validAddresses = forwardToAddresses.filter(addr => addr.trim() !== '');
    if (validAddresses.length === 0) {
      toast.error('Podaj przynajmniej jeden adres email');
      return;
    }
    
    try {
      toast.loading('Przekazywanie wiadomo≈õci...', { id: 'forward-message' });
      
      const result = await communicationApi.forwardMessage(forwardingMessage.id, {
        toAddresses: validAddresses,
        additionalMessage: forwardContent
      });
      
      if (result.success) {
        toast.success('Wiadomo≈õƒá przekazana', { id: 'forward-message' });
        setForwardingMessage(null);
        setForwardToAddresses(['']);
        setForwardContent('');
        loadCommunicationData(); // Refresh messages
      } else {
        throw new Error('Failed to forward message');
      }
    } catch (error) {
      console.error('Error forwarding message:', error);
      toast.error('B≈ÇƒÖd podczas przekazywania wiadomo≈õci', { id: 'forward-message' });
    }
  };

  const handleCancelForward = () => {
    setForwardingMessage(null);
    setForwardToAddresses(['']);
    setForwardContent('');
  };

  const addForwardAddress = () => {
    setForwardToAddresses([...forwardToAddresses, '']);
  };

  const updateForwardAddress = (index: number, value: string) => {
    const newAddresses = [...forwardToAddresses];
    newAddresses[index] = value;
    setForwardToAddresses(newAddresses);
  };

  const removeForwardAddress = (index: number) => {
    if (forwardToAddresses.length > 1) {
      setForwardToAddresses(forwardToAddresses.filter((_, i) => i !== index));
    }
  };

  // Delete Message Function
  const handleDeleteMessage = async (messageId: string) => {
    if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô wiadomo≈õƒá?')) return;
    
    try {
      await communicationApi.deleteMessage(messageId);
      setMessages(messages.filter(m => m.id !== messageId));
      toast.success('Wiadomo≈õƒá usuniƒôta');
    } catch (error) {
      console.error('Error deleting message:', error);
      toast.error('B≈ÇƒÖd podczas usuwania wiadomo≈õci');
    }
  };

  // Archive Message Function
  const handleArchiveMessage = async (messageId: string) => {
    try {
      await communicationApi.archiveMessage(messageId);
      setMessages(messages.filter(m => m.id !== messageId));
      toast.success('Wiadomo≈õƒá zarchiwizowana');
    } catch (error) {
      console.error('Error archiving message:', error);
      toast.error('B≈ÇƒÖd podczas archiwizacji wiadomo≈õci');
    }
  };

  // GTD Functions
  const handleGTDProcess = (message: Message) => {
    setGTDProcessingMessage(message);
    setGTDTaskTitle(message.subject || `Zadanie: ${message.fromName || message.fromAddress}`);
    setGTDNote('');
    setShowGTDModal(true);
  };

  const handleGTDQuickAction = async (messageId: string, action: 'inbox' | 'do' | 'defer') => {
    try {
      const message = messages.find(m => m.id === messageId);
      if (!message) {
        toast.error('Wiadomo≈õƒá nie znaleziona', { id: 'gtd-action' });
        return;
      }

      switch (action) {
        case 'inbox':
          toast.loading('Dodawanie do GTD Inbox...', { id: 'gtd-action' });
          const inboxResult = await communicationApi.addToGTDInbox(messageId, `Wiadomo≈õƒá od: ${message.fromName || message.fromAddress}`);
          if (inboxResult?.success && inboxResult.inboxItemId) {
            toast.success('Dodano do GTD Inbox', { id: 'gtd-action' });
            setMessages(messages.map(m => m.id === messageId ? { ...m, actionNeeded: false } : m));
          } else {
            toast.error('B≈ÇƒÖd podczas dodawania do GTD Inbox', { id: 'gtd-action' });
          }
          break;

        case 'do':
          toast.loading('Tworzenie zadania "DO"...', { id: 'gtd-action' });
          const doResult = await communicationApi.quickDo(messageId, {
            title: message.subject || `Odpowied≈∫ na: ${message.fromName || message.fromAddress}`,
            priority: message.urgencyScore && message.urgencyScore > 70 ? 'HIGH' : 'MEDIUM',
            estimatedTime: 30
          });
          if (doResult?.success && doResult.taskId) {
            toast.success('Utworzono zadanie "DO"', { id: 'gtd-action' });
            setMessages(messages.map(m => m.id === messageId ? { ...m, taskId: doResult.taskId, actionNeeded: false } : m));
          } else {
            toast.error('B≈ÇƒÖd podczas tworzenia zadania "DO"', { id: 'gtd-action' });
          }
          break;

        case 'defer':
          toast.loading('Tworzenie zadania "DEFER"...', { id: 'gtd-action' });
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const deferResult = await communicationApi.quickDefer(messageId, {
            title: message.subject || `P√≥≈∫niej: ${message.fromName || message.fromAddress}`,
            dueDate: tomorrow.toISOString().split('T')[0],
            priority: 'MEDIUM'
          });
          if (deferResult?.success && deferResult.taskId) {
            toast.success('Utworzono zadanie "DEFER" na jutro', { id: 'gtd-action' });
            setMessages(messages.map(m => m.id === messageId ? { ...m, taskId: deferResult.taskId, actionNeeded: false } : m));
          } else {
            toast.error('B≈ÇƒÖd podczas tworzenia zadania "DEFER"', { id: 'gtd-action' });
          }
          break;
      }
    } catch (error) {
      console.error('GTD Quick Action Error:', error);
      toast.error('B≈ÇƒÖd serwera. Spr√≥buj ponownie.', { id: 'gtd-action' });
    }
  };

  const handleGTDSave = async () => {
    if (!gtdProcessingMessage) return;

    try {
      toast.loading('Przetwarzanie GTD...', { id: 'gtd-process' });

      const data: any = {
        taskTitle: gtdTaskTitle,
        context: gtdContext,
        priority: gtdPriority,
        estimatedTime: gtdEstimatedTime,
        note: gtdNote,
        energyLevel: gtdEnergyLevel,
        tags: gtdTags,
        streamId: gtdStreamId || undefined,
        projectId: gtdProjectId || undefined,
        assignedToId: gtdAssignedToId || undefined,
        isWaitingFor: gtdIsWaitingFor,
        waitingForNote: gtdIsWaitingFor ? gtdWaitingForNote : undefined
      };

      if (gtdDecision === 'DEFER' && gtdDueDate) {
        data.dueDate = gtdDueDate;
      }

      if (gtdDecision === 'DELEGATE' && gtdDelegateUser) {
        data.delegateToUserId = gtdDelegateUser;
        if (gtdDueDate) data.dueDate = gtdDueDate;
      }

      if (gtdDecision === 'PROJECT') {
        data.projectTitle = gtdProjectTitle;
        data.priority = gtdProjectPriority;
        data.startDate = gtdStartDate || undefined;
        data.endDate = gtdEndDate || undefined;
        data.projectDescription = gtdProjectDescription;
        data.projectStatus = gtdProjectStatus;
      }

      if (gtdDecision === 'SOMEDAY') {
        data.somedayCategory = gtdSomedayCategory;
        data.somedayWhenToReview = gtdSomedayWhenToReview || undefined;
      }

      if (gtdDecision === 'REFERENCE') {
        data.referenceCategory = gtdReferenceCategory || undefined;
        data.referenceUrl = gtdReferenceUrl || undefined;
      }

      const result = await communicationApi.processWithGTD(gtdProcessingMessage.id, gtdDecision, data);

      if (result.success) {
        toast.success(`Wiadomo≈õƒá przetworzona: ${gtdDecision}`, { id: 'gtd-process' });
        
        // Update message in list
        setMessages(messages.map(m => 
          m.id === gtdProcessingMessage.id 
            ? { 
                ...m, 
                taskId: result.taskId, 
                actionNeeded: false 
              } 
            : m
        ));

        // Close modal and reset
        setShowGTDModal(false);
        setGTDProcessingMessage(null);
        resetGTDForm();

        // Show specific success messages
        if (result.taskId) {
          setTimeout(() => toast.success(`Zadanie utworzone: ${gtdTaskTitle}`), 500);
        }
        if (result.projectId) {
          setTimeout(() => toast.success(`Projekt utworzony: ${gtdProjectTitle}`), 500);
        }
      }
    } catch (error: any) {
      console.error('=== GTD Save Error ===', error);
      console.error('Error response:', error.response);
      console.error('Error data:', error.response?.data);
      const errorMessage = error.response?.data?.error || 'Server error. Please try again later.';
      toast.error(errorMessage, { id: 'gtd-process' });
    }
  };

  const resetGTDForm = () => {
    setGTDDecision('DO');
    setGTDTaskTitle('');
    setGTDContext('@computer');
    setGTDPriority('MEDIUM');
    setGTDDueDate('');
    setGTDEstimatedTime(30);
    setGTDDelegateUser('');
    setGTDProjectTitle('');
    setGTDNote('');
    
    // Reset nowych p√≥l GTD
    setGTDEnergyLevel('MEDIUM');
    setGTDTags([]);
    setGTDStreamId('');
    setGTDProjectId('');
    setGTDAssignedToId('');
    setGTDIsWaitingFor(false);
    setGTDWaitingForNote('');
    
    // Reset p√≥l PROJECT
    setGTDProjectPriority('MEDIUM');
    setGTDProjectStatus('PLANNING');
    setGTDStartDate('');
    setGTDEndDate('');
    setGTDProjectDescription('');
    
    // Reset p√≥l SOMEDAY
    setGTDSomedayCategory('IDEAS');
    setGTDSomedayWhenToReview('');
    
    // Reset p√≥l REFERENCE
    setGTDReferenceCategory('');
    setGTDReferenceUrl('');
  };

  const handleGTDCancel = () => {
    setShowGTDModal(false);
    setGTDProcessingMessage(null);
    resetGTDForm();
  };

  // Quick Email Filtering functions
  const handleQuickFilter = (message: Message) => {
    setQuickFilterMessage(message);
    setQuickFilterCategory('UNKNOWN');
    setQuickFilterCreateRule(false);
    setQuickFilterRuleName('');
    setShowQuickFilterModal(true);
  };

  const handleQuickFilterSave = async () => {
    if (!quickFilterMessage) return;

    try {
      toast.loading('Kategoryzowanie email...', { id: 'quick-filter' });

      // Extract sender domain from email
      const senderDomain = quickFilterMessage.fromAddress.split('@')[1] || '';

      // If user wants to create a rule, create it
      if (quickFilterCreateRule && quickFilterRuleName.trim()) {
        const ruleData = {
          name: quickFilterRuleName,
          description: `Auto-utworzona z wiadomo≈õci: ${quickFilterMessage.subject}`,
          senderDomain: senderDomain,
          assignCategory: quickFilterCategory,
          skipAIAnalysis: quickFilterCategory !== 'VIP' && quickFilterCategory !== 'UNKNOWN',
          autoArchive: quickFilterCategory === 'ARCHIVE' || quickFilterCategory === 'INVOICES',
          autoDelete: quickFilterCategory === 'SPAM',
          createTask: quickFilterCategory === 'INVOICES' || quickFilterCategory === 'VIP',
          priority: quickFilterCategory === 'VIP' ? 100 : 
                   quickFilterCategory === 'SPAM' ? 90 : 50
        };

        await emailRulesApi.createEmailRule(ruleData);
        toast.success('Regu≈Ça filtrowania utworzona!', { id: 'quick-filter' });
      }

      // Update contact category if exists (this would need an API call to find contact)
      // For now, just show success message
      toast.success(`Email oznaczony jako ${quickFilterCategory}`, { id: 'quick-filter' });

      // Close modal
      setShowQuickFilterModal(false);
      setQuickFilterMessage(null);

    } catch (error) {
      console.error('Quick filter error:', error);
      toast.error('B≈ÇƒÖd kategoryzowania email', { id: 'quick-filter' });
    }
  };

  const handleQuickFilterCancel = () => {
    setShowQuickFilterModal(false);
    setQuickFilterMessage(null);
    setQuickFilterCategory('UNKNOWN');
    setQuickFilterCreateRule(false);
    setQuickFilterRuleName('');
  };

  const getCategoryColor = (category: EmailCategory) => {
    const colors = {
      VIP: 'bg-purple-100 text-purple-800',
      SPAM: 'bg-red-100 text-red-800',
      INVOICES: 'bg-blue-100 text-blue-800',
      ARCHIVE: 'bg-gray-100 text-gray-800',
      UNKNOWN: 'bg-yellow-100 text-yellow-800'
    };
    return colors[category] || colors.UNKNOWN;
  };

  const getCategoryIcon = (category: EmailCategory) => {
    const icons = {
      VIP: '‚≠ê',
      SPAM: 'üóëÔ∏è',
      INVOICES: 'üìÑ',
      ARCHIVE: 'üìÅ',
      UNKNOWN: '‚ùì'
    };
    return icons[category] || icons.UNKNOWN;
  };

  const getChannelIcon = (type: string) => {
    switch (type) {
      case 'EMAIL': return 'üìß';
      case 'SLACK': return 'üí¨';
      case 'WHATSAPP': return 'üì±';
      case 'TEAMS': return 'üë•';
      case 'SMS': return 'üí¨';
      default: return 'üì®';
    }
  };

  const getUrgencyColor = (score?: number) => {
    if (!score) return 'text-gray-600';
    if (score >= 80) return 'text-red-600';
    if (score >= 60) return 'text-orange-600';
    if (score >= 40) return 'text-yellow-600';
    return 'text-green-600';
  };

  const formatTimeAgo = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
    return `${Math.floor(diffInMinutes / 1440)}d ago`;
  };

  const totalUnread = channels.reduce((sum, channel) => sum + channel.unreadCount, 0);
  const totalChannels = channels.length;
  const activeChannels = channels.filter(c => c.active).length;
  const processedMessages = messages.filter(m => m.taskId).length;
  const processingRate = messages.length > 0 ? Math.round((processedMessages / messages.length) * 100) : 0;

  console.log('Rendering component with state:', { loading, channelsCount: channels.length, messagesCount: messages.length });

  if (loading) {
    return (
      <div className="flex justify-center items-center h-96">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Centrum komunikacji</h1>
          <p className="text-gray-600">Zunifikowana skrzynka dla wszystkich kana≈Ç√≥w komunikacji</p>
        </div>
        <div className="flex items-center space-x-3">
          {lastRefresh && (
            <div className="text-sm text-gray-500">
              Ostatnie od≈õwie≈ºenie: {lastRefresh.toLocaleTimeString('pl-PL')}
            </div>
          )}
          <button 
            onClick={() => loadCommunicationData()}
            disabled={loading}
            className="btn btn-outline clickable"
            title="Od≈õwie≈º dane"
          >
            <svg className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            {loading ? 'Od≈õwie≈ºanie...' : 'Od≈õwie≈º'}
          </button>
          <button 
            onClick={() => setShowChannelModal(true)}
            className="btn btn-primary clickable"
          >
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
            Dodaj kana≈Ç
          </button>
        </div>
      </div>
      
      {/* Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Active Channels</p>
              <p className="text-2xl font-bold text-gray-900">{activeChannels}</p>
            </div>
            <div className="text-3xl">üì°</div>
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Unread Messages</p>
              <p className="text-2xl font-bold text-red-600">{totalUnread}</p>
            </div>
            <div className="text-3xl">üì¨</div>
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Auto-Processed</p>
              <p className="text-2xl font-bold text-green-600">{processingRate}%</p>
            </div>
            <div className="text-3xl">ü§ñ</div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Total Messages</p>
              <p className="text-2xl font-bold text-gray-900">{messages.length}</p>
            </div>
            <div className="text-3xl">üì®</div>
          </div>
        </div>
      </div>

      {/* Inteligentne skrzynki - wzorowane na Outlook */}
      <div className="bg-white rounded-lg shadow">
        <div className="px-6 py-4 border-b border-gray-200">
          <h2 className="text-lg font-semibold text-gray-900">Inteligentne skrzynki</h2>
          <p className="text-sm text-gray-600">Automatycznie kategoryzowane wiadomo≈õci</p>
        </div>
        <div className="p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Skrzynka odbiorcza */}
            <button
              onClick={() => setSelectedFilter('all')}
              className={`clickable p-4 rounded-lg border-2 transition-all ${
                selectedFilter === 'all' 
                  ? 'border-blue-500 bg-blue-50' 
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className="flex items-center space-x-3">
                <div className="text-2xl">üì¨</div>
                <div className="text-left">
                  <h3 className="font-semibold text-gray-900">Skrzynka odbiorcza</h3>
                  <p className="text-sm text-gray-600">{messages.length} wiadomo≈õci</p>
                </div>
              </div>
            </button>

            {/* Nieprzeczytane */}
            <button
              onClick={() => setSelectedFilter('unread')}
              className={`clickable p-4 rounded-lg border-2 transition-all ${
                selectedFilter === 'unread' 
                  ? 'border-red-500 bg-red-50' 
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className="flex items-center space-x-3">
                <div className="text-2xl">üì≠</div>
                <div className="text-left">
                  <h3 className="font-semibold text-gray-900">Nieprzeczytane</h3>
                  <p className="text-sm text-gray-600">{messages.filter(m => !m.isRead).length} nowych</p>
                </div>
              </div>
            </button>

            {/* Wa≈ºne / WymagajƒÖ dzia≈Çania */}
            <button
              onClick={() => setSelectedFilter('action-needed')}
              className={`clickable p-4 rounded-lg border-2 transition-all ${
                selectedFilter === 'action-needed' 
                  ? 'border-orange-500 bg-orange-50' 
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className="flex items-center space-x-3">
                <div className="text-2xl">‚ö°</div>
                <div className="text-left">
                  <h3 className="font-semibold text-gray-900">WymagajƒÖ dzia≈Çania</h3>
                  <p className="text-sm text-gray-600">{messages.filter(m => m.actionNeeded).length} pilnych</p>
                </div>
              </div>
            </button>

            {/* Przetworzone */}
            <button
              onClick={() => setSelectedFilter('processed')}
              className={`clickable p-4 rounded-lg border-2 transition-all ${
                selectedFilter === 'processed' 
                  ? 'border-green-500 bg-green-50' 
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className="flex items-center space-x-3">
                <div className="text-2xl">‚úÖ</div>
                <div className="text-left">
                  <h3 className="font-semibold text-gray-900">Przetworzone</h3>
                  <p className="text-sm text-gray-600">{messages.filter(m => m.taskId).length} zada≈Ñ</p>
                </div>
              </div>
            </button>
          </div>

          {/* Dodatkowe filtry w drugim rzƒôdzie */}
          <div className="mt-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
            {/* Filtr wed≈Çug kana≈Ç√≥w */}
            <div className="relative">
              <select 
                onChange={(e) => setChannelFilter(e.target.value)}
                value={channelFilter}
                className="clickable w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="all">üì° Wszystkie kana≈Çy</option>
                {channels.map(channel => (
                  <option key={channel.id} value={channel.id}>
                    {getChannelIcon(channel.type)} {channel.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Filtr wed≈Çug daty */}
            <div className="relative">
              <select className="clickable w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                <option>üìÖ Dzisiaj</option>
                <option>üìÖ Wczoraj</option>
                <option>üìÖ Ten tydzie≈Ñ</option>
                <option>üìÖ Ten miesiƒÖc</option>
              </select>
            </div>

            {/* Filtr wed≈Çug nadawcy */}
            <div className="relative">
              <input
                type="text"
                placeholder="üîç Szukaj nadawcy..."
                className="clickable w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              />
            </div>

            {/* Filtr wed≈Çug za≈ÇƒÖcznik√≥w */}
            <button className="clickable p-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 focus:ring-2 focus:ring-blue-500">
              üìé Z za≈ÇƒÖcznikami
            </button>

            {/* Filtr VIP */}
            <button className="clickable p-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 focus:ring-2 focus:ring-blue-500">
              ‚≠ê VIP
            </button>

            {/* Reset filtr√≥w */}
            <button 
              onClick={() => {
                setSelectedFilter('all');
                setChannelFilter('all');
              }}
              className="clickable p-2 text-sm bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:ring-2 focus:ring-blue-500"
            >
              üîÑ Reset
            </button>
          </div>
        </div>
      </div>


      {/* Recent Messages */}
      <div className="bg-white rounded-lg shadow">
        <div className="px-6 py-4 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">
                Messages ({getFilteredMessages().length} / {messages.length})
              </h2>
              {selectedFilter !== 'all' && (
                <p className="text-sm text-gray-600 mt-1">
                  Filtr: {selectedFilter.replace('-', ' ')}
                  {channelFilter !== 'all' && ` ‚Ä¢ Kana≈Ç: ${channels.find(ch => ch.id === channelFilter)?.name || 'Nieznany'}`}
                </p>
              )}
            </div>
            <div className="flex space-x-2">
              <button
                onClick={() => loadCommunicationData()}
                disabled={loading}
                className="btn btn-outline btn-sm"
                title="Od≈õwie≈º wiadomo≈õci"
              >
                <svg className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
              
              <button
                onClick={() => {
                  // Check if bulk analysis is already in progress
                  if (bulkAnalysisInProgress) {
                    toast.error('Bulk AI analysis is already in progress');
                    return;
                  }

                  // Better filtering to avoid analyzing already processed messages or currently analyzing ones
                  const unprocessedMessages = getFilteredMessages().filter(msg => 
                    !msg.contactId && 
                    !msg.taskId && 
                    !analyzingMessages.has(msg.id)
                  );
                  
                  if (unprocessedMessages.length > 0) {
                    const confirmMsg = `Analyze ${unprocessedMessages.length} unprocessed messages with AI?`;
                    if (confirm(confirmMsg)) {
                      // Set bulk analysis in progress
                      setBulkAnalysisInProgress(true);
                      
                      // Clear any existing timeouts
                      bulkAnalysisTimeouts.current.forEach(timeout => clearTimeout(timeout));
                      bulkAnalysisTimeouts.current = [];
                      
                      // Store timeouts so they can be cancelled
                      unprocessedMessages.forEach((msg, index) => {
                        const timeout = setTimeout(() => {
                          handleAnalyzeWithAI(msg.id);
                          
                          // Check if this was the last message
                          if (index === unprocessedMessages.length - 1) {
                            // Add small delay to ensure last analysis completes
                            setTimeout(() => {
                              setBulkAnalysisInProgress(false);
                              toast.success(`Bulk AI analysis completed for ${unprocessedMessages.length} messages`);
                            }, 2000);
                          }
                        }, index * 1000); // 1 second delay between calls
                        
                        bulkAnalysisTimeouts.current.push(timeout);
                      });
                      
                      toast(`Starting bulk analysis of ${unprocessedMessages.length} messages...`, { icon: 'ü§ñ' });
                    }
                  } else {
                    toast('All visible messages are already processed or being analyzed', { icon: '‚ÑπÔ∏è' });
                  }
                }}
                disabled={loading || bulkAnalysisInProgress}
                className={`btn btn-sm text-white ${
                  bulkAnalysisInProgress 
                    ? 'bg-orange-600 hover:bg-orange-700 cursor-not-allowed' 
                    : 'bg-purple-600 hover:bg-purple-700'
                }`}
                title={bulkAnalysisInProgress ? "Bulk AI analysis in progress..." : "Analyze all unprocessed messages with AI"}
              >
                {bulkAnalysisInProgress ? (
                  <>
                    <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing...
                  </>
                ) : (
                  'ü§ñ Bulk AI Analysis'
                )}
              </button>
              
              {/* Cancel Bulk Analysis Button - only show when analysis is in progress */}
              {bulkAnalysisInProgress && (
                <button
                  onClick={() => {
                    // Cancel all pending timeouts
                    bulkAnalysisTimeouts.current.forEach(timeout => clearTimeout(timeout));
                    bulkAnalysisTimeouts.current = [];
                    setBulkAnalysisInProgress(false);
                    toast('Bulk AI analysis cancelled', { icon: '‚ùå' });
                  }}
                  className="btn btn-sm bg-red-600 text-white hover:bg-red-700"
                  title="Cancel bulk AI analysis"
                >
                  ‚ùå Cancel Analysis
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Bulk Actions Toolbar */}
        <div className="px-6 py-3 border-b border-gray-200 bg-gray-50">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="flex items-center space-x-2">
                <input
                  type="checkbox"
                  checked={selectAll}
                  onChange={handleSelectAll}
                  className="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                />
                <span className="text-sm text-gray-700">
                  {selectedMessages.size > 0 
                    ? `Zaznaczono ${selectedMessages.size} wiadomo≈õci`
                    : 'Zaznacz wszystkie'
                  }
                </span>
              </div>

              <div className="flex items-center space-x-2">
                <button
                  onClick={() => setLayout(layout === 'list' ? 'preview' : 'list')}
                  className="p-2 text-gray-600 hover:bg-gray-200 rounded-md"
                  title={layout === 'list' ? 'Poka≈º podglƒÖd' : 'Poka≈º listƒô'}
                >
                  {layout === 'list' ? (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                  ) : (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                  )}
                </button>
              </div>
            </div>

            {showBulkActions && (
              <div className="flex items-center space-x-2">
                <button
                  onClick={handleBulkMarkAsRead}
                  className="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200"
                >
                  üìñ Oznacz jako przeczytane
                </button>
                <button
                  onClick={() => setShowRuleSelector(true)}
                  className="px-3 py-1 text-sm bg-green-100 text-green-800 rounded-md hover:bg-green-200"
                >
                  üîÑ Zastosuj regu≈Çƒô
                </button>
                <button
                  onClick={handleBulkDelete}
                  className="px-3 py-1 text-sm bg-red-100 text-red-800 rounded-md hover:bg-red-200"
                >
                  üóëÔ∏è Usu≈Ñ
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Rule Selector Modal */}
        {showRuleSelector && (
          <div className="px-6 py-4 border-b border-gray-200 bg-blue-50">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-4 flex-1">
                <span className="text-sm font-medium text-gray-900">
                  Zastosuj regu≈Çƒô do {selectedMessages.size} wiadomo≈õci:
                </span>
                
                <select
                  value={selectedRule}
                  onChange={(e) => setSelectedRule(e.target.value)}
                  className="px-3 py-1 border border-gray-300 rounded-md text-sm"
                >
                  <option value="">Wybierz regu≈Çƒô...</option>
                  {availableRules.map(rule => (
                    <option key={rule.id} value={rule.id}>
                      {rule.name}
                    </option>
                  ))}
                </select>

                <div className="flex items-center space-x-2">
                  <label className="flex items-center space-x-1">
                    <input
                      type="radio"
                      name="ruleApplication"
                      value="once"
                      checked={ruleApplication === 'once'}
                      onChange={(e) => setRuleApplication(e.target.value as 'once' | 'always')}
                      className="h-3 w-3 text-primary-600"
                    />
                    <span className="text-xs">Jednorazowo</span>
                  </label>
                  <label className="flex items-center space-x-1">
                    <input
                      type="radio"
                      name="ruleApplication"
                      value="always"
                      checked={ruleApplication === 'always'}
                      onChange={(e) => setRuleApplication(e.target.value as 'once' | 'always')}
                      className="h-3 w-3 text-primary-600"
                    />
                    <span className="text-xs">Ka≈ºdorazowo</span>
                  </label>
                </div>
              </div>

              <div className="flex items-center space-x-2">
                <button
                  onClick={handleApplyRule}
                  disabled={!selectedRule}
                  className="px-4 py-1 bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50 text-sm"
                >
                  Zastosuj
                </button>
                <button
                  onClick={() => {
                    setShowRuleSelector(false);
                    setSelectedRule('');
                  }}
                  className="px-3 py-1 text-gray-600 hover:text-gray-800 text-sm"
                >
                  Anuluj
                </button>
              </div>
            </div>
            {ruleApplication === 'always' && (
              <p className="text-xs text-blue-600 mt-2">
                ‚ö†Ô∏è Regu≈Ça bƒôdzie automatycznie stosowana do przysz≈Çych wiadomo≈õci spe≈ÇniajƒÖcych warunki
              </p>
            )}
          </div>
        )}
        
        {getFilteredMessages().length === 0 ? (
          <div className="p-6">
            <div className="text-center py-8">
              <div className="text-4xl mb-4">üì≠</div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">Brak wiadomo≈õci</h3>
              <p className="text-gray-600">
                {selectedFilter === 'all' 
                  ? 'Nie znaleziono wiadomo≈õci w ≈ºadnym kanale'
                  : `Brak wiadomo≈õci: ${selectedFilter.replace('-', ' ')}`
                }
              </p>
              <p className="text-sm text-red-600 mt-2">
                DEBUG: Za≈Çadowano {messages.length} wiadomo≈õci, wyfiltrowanych: {getFilteredMessages().length}
                <br />
                Kana≈Çy: {channels.map(ch => `${ch.name} (${ch.id.slice(0,8)})`).join(', ')}
                <br />
                Kana≈Çy w wiadomo≈õciach: {[...new Set(messages.map(m => m.channelId))].map(id => `${id.slice(0,8)}`).join(', ')}
              </p>
              {channels.length > 0 && messages.length === 0 && (
                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <p className="text-sm text-blue-800">
                    üí° <strong>Wskaz√≥wka:</strong> Je≈õli doda≈Çe≈õ nowy kana≈Ç, przejd≈∫ do <strong>Kana≈Çy komunikacji</strong> i u≈ºyj przycisku synchronizacji (üîÑ) aby pobraƒá wiadomo≈õci.
                  </p>
                </div>
              )}
            </div>
          </div>
        ) : (
          <div className="divide-y divide-gray-200">
            {getFilteredMessages().map((message) => (
              <div key={message.id} className={`p-6 hover:bg-gray-50 ${selectedMessages.has(message.id) ? 'bg-blue-50 border border-blue-200' : ''}`}>
                <div className="flex items-start justify-between">
                  <div className="flex items-start space-x-4 flex-1">
                    <input
                      type="checkbox"
                      checked={selectedMessages.has(message.id)}
                      onChange={(e) => {
                        const newSelected = new Set(selectedMessages);
                        if (e.target.checked) {
                          newSelected.add(message.id);
                        } else {
                          newSelected.delete(message.id);
                        }
                        setSelectedMessages(newSelected);
                        setShowBulkActions(newSelected.size > 0);
                      }}
                      className="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded mt-1"
                    />
                    <div className="text-2xl">
                      {getChannelIcon(message.channel.type)}
                    </div>
                    
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center space-x-3 mb-2">
                        <h3 className="text-sm font-medium text-gray-900">
                          {message.fromName || message.fromAddress}
                        </h3>
                        <span className="text-xs text-gray-500">{message.channel.name}</span>
                        <span className="text-xs text-gray-500">{formatTimeAgo(message.receivedAt)}</span>
                        
                        {message.urgencyScore && (
                          <span className={`text-xs font-medium ${getUrgencyColor(message.urgencyScore)}`}>
                            Urgency: {message.urgencyScore}%
                          </span>
                        )}
                        
                        {!message.isRead && (
                          <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">
                            NEW
                          </span>
                        )}
                        
                        {message.actionNeeded && (
                          <span className="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded">
                            ACTION NEEDED
                          </span>
                        )}
                        
                        {message.taskId && (
                          <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">
                            PROCESSED
                          </span>
                        )}
                      </div>
                      
                      {message.subject && (
                        <h4 className="text-lg font-medium text-gray-900 mb-1">
                          {message.subject}
                        </h4>
                      )}
                      
                      <p className="text-gray-600 text-sm line-clamp-2 mb-2">
                        {message.content}
                      </p>
                      
                      {message.task && (
                        <div className="text-sm text-gray-600">
                          üìã Created task: <span className="font-medium">{message.task.title}</span>
                        </div>
                      )}
                      
                      {/* CRM Information */}
                      <div className="flex flex-wrap gap-2 mt-2">
                        {message.contact && (
                          <div className="flex items-center space-x-1 text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded">
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span>{message.contact.firstName} {message.contact.lastName}</span>
                            <span className="text-blue-500">({message.contact.status})</span>
                          </div>
                        )}
                        
                        {message.company && (
                          <div className="flex items-center space-x-1 text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded">
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <span>{message.company.name}</span>
                            <span className="text-purple-500">({message.company.status})</span>
                          </div>
                        )}
                        
                        {message.deal && (
                          <div className="flex items-center space-x-1 text-xs bg-green-50 text-green-700 px-2 py-1 rounded">
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>{message.deal.title}</span>
                            <span className="text-green-500">({message.deal.stage})</span>
                            {message.deal.value && (
                              <span className="font-medium">${message.deal.value.toLocaleString()}</span>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex items-center space-x-2 ml-4">
                    {!message.isRead && (
                      <button
                        onClick={() => handleMarkAsRead(message.id)}
                        className="clickable p-2 text-gray-600 hover:bg-gray-100 rounded-md"
                        title="Mark as read"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                      </button>
                    )}

                    {/* Edit Button */}
                    <button
                      onClick={() => handleEditMessage(message)}
                      className="clickable p-2 text-gray-600 hover:bg-gray-100 rounded-md"
                      title="Edytuj wiadomo≈õƒá"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                    </button>

                    {/* Reply Button */}
                    <button
                      onClick={() => handleReplyToMessage(message)}
                      className="clickable p-2 text-blue-600 hover:bg-blue-100 rounded-md"
                      title="Odpowiedz"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                      </svg>
                    </button>

                    {/* Forward Button */}
                    <button
                      onClick={() => handleForwardMessage(message)}
                      className="clickable p-2 text-green-600 hover:bg-green-100 rounded-md"
                      title="Przeka≈º"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                      </svg>
                    </button>

                    {/* Archive Button */}
                    <button
                      onClick={() => handleArchiveMessage(message.id)}
                      className="clickable p-2 text-yellow-600 hover:bg-yellow-100 rounded-md"
                      title="Archiwizuj"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8l6 6m0 0l6-6m-6 6V3" />
                      </svg>
                    </button>

                    {/* Delete Button */}
                    <button
                      onClick={() => handleDeleteMessage(message.id)}
                      className="clickable p-2 text-red-600 hover:bg-red-100 rounded-md"
                      title="Usu≈Ñ"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>

                    {/* GTD Divider */}
                    <div className="border-l border-gray-300 h-6 mx-2"></div>

                    {/* GTD Quick Actions */}
                    <button
                      onClick={() => handleGTDQuickAction(message.id, 'inbox')}
                      className="clickable px-2 py-1 text-xs font-medium text-orange-600 hover:bg-orange-100 rounded-md border border-orange-200"
                      title="üì• Dodaj do GTD Inbox"
                    >
                      üì• Inbox
                    </button>

                    <button
                      onClick={() => handleGTDQuickAction(message.id, 'do')}
                      className="clickable px-2 py-1 text-xs font-medium text-green-600 hover:bg-green-100 rounded-md border border-green-200"
                      title="‚úÖ Utw√≥rz zadanie DO (natychmiastowe)"
                    >
                      ‚úÖ DO
                    </button>

                    <button
                      onClick={() => handleGTDQuickAction(message.id, 'defer')}
                      className="clickable px-2 py-1 text-xs font-medium text-blue-600 hover:bg-blue-100 rounded-md border border-blue-200"
                      title="‚è≥ Utw√≥rz zadanie DEFER (na jutro)"
                    >
                      ‚è≥ DEFER
                    </button>

                    <button
                      onClick={() => handleGTDProcess(message)}
                      className="clickable px-2 py-1 text-xs font-medium text-purple-600 hover:bg-purple-100 rounded-md border border-purple-200"
                      title="üéØ Pe≈Çne przetwarzanie GTD"
                    >
                      üéØ GTD+
                    </button>

                    {/* Email Filter Divider */}
                    <div className="border-l border-gray-300 h-6 mx-2"></div>

                    {/* Quick Email Filter Button */}
                    <button
                      onClick={() => handleQuickFilter(message)}
                      className="clickable px-2 py-1 text-xs font-medium text-indigo-600 hover:bg-indigo-100 rounded-md border border-indigo-200"
                      title="üéØ Szybki filtr email - kategoryzuj i utw√≥rz regu≈Çƒô"
                    >
                      üéØ Filtruj
                    </button>
                    
                    {message.actionNeeded && !message.taskId && (
                      <button
                        onClick={() => handleProcessMessage(message.id)}
                        className="clickable px-3 py-1 text-sm font-medium text-green-600 hover:bg-green-100 rounded-md"
                      >
                        Process
                      </button>
                    )}
                    
                    {message.taskId && (
                      <button
                        onClick={() => window.location.href = `/crm/dashboard/tasks/${message.taskId}`}
                        className="clickable px-3 py-1 text-sm font-medium text-blue-600 hover:bg-blue-100 rounded-md"
                      >
                        View Task
                      </button>
                    )}

                    <button
                      onClick={() => handleAnalyzeWithAI(message.id)}
                      className="clickable px-3 py-1 text-sm font-medium text-purple-600 hover:bg-purple-100 rounded-md border border-purple-200"
                      title="Analyze with AI (CRM + GTD + SMART) - Shortcut: Ctrl/Cmd + A"
                    >
                      ü§ñ AI Analysis
                      <span className="text-xs text-purple-400 ml-1">‚åòA</span>
                    </button>
                    
                    {/* Manual CRM Link Button */}
                    {(message.contact || message.company || message.deal) && !message.taskId && (
                      <button
                        onClick={async () => {
                          try {
                            const result = await communicationApi.linkMessageToCRM(message.id, {
                              contactId: message.contactId,
                              companyId: message.companyId,
                              dealId: message.dealId
                            });
                            
                            if (result.success) {
                              toast.success('Communication logged to CRM timeline!');
                            } else {
                              toast.error('Failed to log communication activity');
                            }
                          } catch (error) {
                            toast.error('Error logging communication');
                          }
                        }}
                        className="clickable px-3 py-1 text-sm font-medium text-green-600 hover:bg-green-100 rounded-md border border-green-200"
                        title="Log this communication to CRM timeline"
                      >
                        üìù Log to CRM
                      </button>
                    )}
                    
                    <button
                      onClick={() => {
                        console.log('Opening message:', message);
                        setSelectedMessage(message);
                      }}
                      className="clickable p-2 text-gray-600 hover:bg-gray-100 rounded-md"
                      title="Zobacz szczeg√≥≈Çy"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Add Channel Modal */}
      {showChannelModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">Add Communication Channel</h3>
                <button
                  onClick={() => setShowChannelModal(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6">
              <div className="space-y-4">
                <p className="text-sm text-gray-600 mb-4">
                  Choose a communication channel to add to your unified inbox.
                </p>
                
                <div className="space-y-3">
                  <button 
                    onClick={() => {
                      toast('Email setup will be available in next update');
                      setShowChannelModal(false);
                    }}
                    className="w-full flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50"
                  >
                    <div className="flex items-center space-x-3">
                      <span className="text-2xl">üìß</span>
                      <div className="text-left">
                        <div className="font-medium text-gray-900">Email Account</div>
                        <div className="text-sm text-gray-600">Connect Gmail, Outlook, or other IMAP</div>
                      </div>
                    </div>
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                  
                  <button 
                    onClick={() => {
                      toast('Slack integration coming soon');
                      setShowChannelModal(false);
                    }}
                    className="w-full flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50"
                  >
                    <div className="flex items-center space-x-3">
                      <span className="text-2xl">üí¨</span>
                      <div className="text-left">
                        <div className="font-medium text-gray-900">Slack Workspace</div>
                        <div className="text-sm text-gray-600">Connect your Slack channels</div>
                      </div>
                    </div>
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>

                  <button 
                    onClick={() => {
                      toast('WhatsApp Business API integration planned');
                      setShowChannelModal(false);
                    }}
                    className="w-full flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50"
                  >
                    <div className="flex items-center space-x-3">
                      <span className="text-2xl">üì±</span>
                      <div className="text-left">
                        <div className="font-medium text-gray-900">WhatsApp Business</div>
                        <div className="text-sm text-gray-600">Business messaging integration</div>
                      </div>
                    </div>
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>

              <div className="flex items-center justify-end space-x-3 mt-6">
                <button
                  onClick={() => setShowChannelModal(false)}
                  className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Message Details Modal */}
      {selectedMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">Szczeg√≥≈Çy wiadomo≈õci</h3>
                <button
                  onClick={() => setSelectedMessage(null)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
              <div className="space-y-6">
                {/* Message Header */}
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="flex items-center space-x-3 mb-3">
                    <div className="text-2xl">{getChannelIcon(selectedMessage.channel.type)}</div>
                    <div>
                      <h4 className="font-medium text-gray-900">
                        {selectedMessage.fromName || selectedMessage.fromAddress}
                      </h4>
                      <p className="text-sm text-gray-600">{selectedMessage.channel.name}</p>
                    </div>
                    <div className="ml-auto text-sm text-gray-500">
                      {formatTimeAgo(selectedMessage.receivedAt)}
                    </div>
                  </div>
                  
                  {selectedMessage.subject && (
                    <h3 className="text-xl font-semibold text-gray-900 mb-2">
                      {selectedMessage.subject}
                    </h3>
                  )}
                  
                  <div className="flex items-center space-x-3">
                    {selectedMessage.urgencyScore && (
                      <span className={`px-2 py-1 text-xs font-medium rounded ${getUrgencyColor(selectedMessage.urgencyScore)}`}>
                        Pilno≈õƒá: {selectedMessage.urgencyScore}%
                      </span>
                    )}
                    
                    {!selectedMessage.isRead && (
                      <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">
                        NOWA
                      </span>
                    )}
                    
                    {selectedMessage.actionNeeded && (
                      <span className="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded">
                        WYMAGA DZIA≈ÅANIA
                      </span>
                    )}
                    
                    {selectedMessage.taskId && (
                      <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">
                        PRZETWORZONA
                      </span>
                    )}
                  </div>
                </div>

                {/* Message Content */}
                <div className="bg-white border border-gray-200 rounded-lg p-4">
                  <h4 className="font-medium text-gray-900 mb-3">Tre≈õƒá wiadomo≈õci</h4>
                  <div className="prose max-w-none">
                    <p className="text-gray-700 whitespace-pre-wrap">
                      {selectedMessage.content}
                    </p>
                  </div>
                </div>

                {/* Associated Task */}
                {selectedMessage.task && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 className="font-medium text-green-900 mb-2">PowiƒÖzane zadanie</h4>
                    <p className="text-green-700">üìã {selectedMessage.task.title}</p>
                    <button
                      onClick={() => window.location.href = `/crm/dashboard/tasks/${selectedMessage.taskId}`}
                      className="mt-2 text-sm text-green-600 hover:text-green-800 underline"
                    >
                      Zobacz zadanie ‚Üí
                    </button>
                  </div>
                )}

                {/* AI Analysis Report */}
                <MessageAnalysisReport 
                  messageId={selectedMessage.id}
                  onAnalysisUpdate={(analysis) => {
                    // Update the message with analysis results if needed
                    console.log('Analysis updated:', analysis);
                  }}
                />

                {/* Actions */}
                <div className="flex items-center justify-between pt-4 border-t border-gray-200">
                  <div className="flex items-center space-x-3">
                    {!selectedMessage.isRead && (
                      <button
                        onClick={() => {
                          handleMarkAsRead(selectedMessage.id);
                          setSelectedMessage({ ...selectedMessage, isRead: true });
                        }}
                        className="btn btn-outline-primary"
                      >
                        Oznacz jako przeczytane
                      </button>
                    )}
                    
                    {selectedMessage.actionNeeded && !selectedMessage.taskId && (
                      <button
                        onClick={() => handleProcessMessage(selectedMessage.id)}
                        className="btn btn-primary"
                      >
                        Przetw√≥rz wiadomo≈õƒá
                      </button>
                    )}
                  </div>
                  
                  <button
                    onClick={() => setSelectedMessage(null)}
                    className="btn btn-outline-secondary"
                  >
                    Zamknij
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Edit Message Modal */}
      {editingMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">Edytuj wiadomo≈õƒá</h3>
                <button
                  onClick={handleCancelEdit}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6">
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Temat</label>
                  <input
                    type="text"
                    value={editSubject}
                    onChange={(e) => setEditSubject(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Temat wiadomo≈õci..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Tre≈õƒá</label>
                  <textarea
                    value={editContent}
                    onChange={(e) => setEditContent(e.target.value)}
                    rows={10}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Tre≈õƒá wiadomo≈õci..."
                  />
                </div>
              </div>

              <div className="flex items-center justify-end space-x-3 mt-6">
                <button
                  onClick={handleCancelEdit}
                  className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                >
                  Anuluj
                </button>
                <button
                  onClick={handleSaveEdit}
                  className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
                >
                  Zapisz zmiany
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Reply Modal */}
      {replyingToMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">Odpowiedz na wiadomo≈õƒá</h3>
                <button
                  onClick={handleCancelReply}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6">
              {/* Original Message Preview */}
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 className="font-medium text-gray-900 mb-2">Oryginalna wiadomo≈õƒá:</h4>
                <div className="text-sm text-gray-600">
                  <div className="flex items-center space-x-2 mb-2">
                    <span className="font-medium">Od:</span>
                    <span>{replyingToMessage.fromName || replyingToMessage.fromAddress}</span>
                  </div>
                  {replyingToMessage.subject && (
                    <div className="flex items-center space-x-2 mb-2">
                      <span className="font-medium">Temat:</span>
                      <span>{replyingToMessage.subject}</span>
                    </div>
                  )}
                  <div className="mt-2 p-3 bg-white rounded border">
                    <p className="text-gray-700 line-clamp-3">{replyingToMessage.content}</p>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Do</label>
                  <input
                    type="email"
                    value={replyToAddress}
                    onChange={(e) => setReplyToAddress(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Adres email odbiorcy..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Temat</label>
                  <input
                    type="text"
                    value={replySubject}
                    onChange={(e) => setReplySubject(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Temat odpowiedzi..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Twoja odpowied≈∫</label>
                  <textarea
                    value={replyContent}
                    onChange={(e) => setReplyContent(e.target.value)}
                    rows={8}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Napisz swojƒÖ odpowied≈∫..."
                  />
                </div>
              </div>

              <div className="flex items-center justify-end space-x-3 mt-6">
                <button
                  onClick={handleCancelReply}
                  className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                >
                  Anuluj
                </button>
                <button
                  onClick={handleSendReply}
                  className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
                >
                  Wy≈õlij odpowied≈∫
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Forward Modal */}
      {forwardingMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">Przeka≈º wiadomo≈õƒá</h3>
                <button
                  onClick={handleCancelForward}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6">
              {/* Original Message Preview */}
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 className="font-medium text-gray-900 mb-2">Przekazywana wiadomo≈õƒá:</h4>
                <div className="text-sm text-gray-600">
                  <div className="flex items-center space-x-2 mb-2">
                    <span className="font-medium">Od:</span>
                    <span>{forwardingMessage.fromName || forwardingMessage.fromAddress}</span>
                  </div>
                  {forwardingMessage.subject && (
                    <div className="flex items-center space-x-2 mb-2">
                      <span className="font-medium">Temat:</span>
                      <span>{forwardingMessage.subject}</span>
                    </div>
                  )}
                  <div className="mt-2 p-3 bg-white rounded border max-h-32 overflow-y-auto">
                    <p className="text-gray-700">{forwardingMessage.content}</p>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Przeka≈º do</label>
                  {forwardToAddresses.map((address, index) => (
                    <div key={index} className="flex items-center space-x-2 mb-2">
                      <input
                        type="email"
                        value={address}
                        onChange={(e) => updateForwardAddress(index, e.target.value)}
                        className="flex-1 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        placeholder="Adres email odbiorcy..."
                      />
                      {forwardToAddresses.length > 1 && (
                        <button
                          onClick={() => removeForwardAddress(index)}
                          className="p-2 text-red-600 hover:bg-red-100 rounded-md"
                          title="Usu≈Ñ adres"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      )}
                    </div>
                  ))}
                  <button
                    onClick={addForwardAddress}
                    className="text-sm text-blue-600 hover:text-blue-800"
                  >
                    + Dodaj kolejny adres
                  </button>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Dodatkowa wiadomo≈õƒá (opcjonalnie)</label>
                  <textarea
                    value={forwardContent}
                    onChange={(e) => setForwardContent(e.target.value)}
                    rows={4}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Dodaj swojƒÖ wiadomo≈õƒá do przekazywanej wiadomo≈õci..."
                  />
                </div>
              </div>

              <div className="flex items-center justify-end space-x-3 mt-6">
                <button
                  onClick={handleCancelForward}
                  className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                >
                  Anuluj
                </button>
                <button
                  onClick={handleSendForward}
                  className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700"
                >
                  Przeka≈º wiadomo≈õƒá
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* GTD Processing Modal */}
      {showGTDModal && gtdProcessingMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">üéØ Przetwarzanie GTD</h3>
                <button
                  onClick={handleGTDCancel}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
              {/* Original Message Preview */}
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 className="font-medium text-gray-900 mb-2">üìß Wiadomo≈õƒá do przetworzenia:</h4>
                <div className="text-sm text-gray-600">
                  <div className="flex items-center space-x-2 mb-2">
                    <span className="font-medium">Od:</span>
                    <span>{gtdProcessingMessage.fromName || gtdProcessingMessage.fromAddress}</span>
                  </div>
                  {gtdProcessingMessage.subject && (
                    <div className="flex items-center space-x-2 mb-2">
                      <span className="font-medium">Temat:</span>
                      <span>{gtdProcessingMessage.subject}</span>
                    </div>
                  )}
                  <div className="mt-2 p-3 bg-white rounded border max-h-32 overflow-y-auto">
                    <p className="text-gray-700">{gtdProcessingMessage.content}</p>
                  </div>
                </div>
              </div>

              {/* GTD Decision Selector */}
              <div className="mb-6">
                <h4 className="font-medium text-gray-900 mb-3">üéØ Decyzja GTD</h4>
                <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
                  {[
                    { value: 'DO', label: '‚úÖ DO', desc: 'Zr√≥b to teraz (< 2 min)' },
                    { value: 'DEFER', label: '‚è≥ DEFER', desc: 'Zaplanuj na p√≥≈∫niej' },
                    { value: 'DELEGATE', label: 'üë• DELEGATE', desc: 'Przypisz komu≈õ' },
                    { value: 'PROJECT', label: 'üìÅ PROJECT', desc: 'Wymaga kilku krok√≥w' },
                    { value: 'REFERENCE', label: 'üìö REFERENCE', desc: 'Materia≈Ç referencyjny' },
                    { value: 'SOMEDAY', label: 'üåü SOMEDAY', desc: 'Mo≈ºe kiedy≈õ' },
                    { value: 'DELETE', label: 'üóëÔ∏è DELETE', desc: 'Nie wymaga dzia≈Çania' },
                  ].map((decision) => (
                    <button
                      key={decision.value}
                      onClick={() => setGTDDecision(decision.value as any)}
                      className={`p-3 text-left border-2 rounded-lg transition-all ${
                        gtdDecision === decision.value
                          ? 'border-blue-500 bg-blue-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="font-medium text-sm">{decision.label}</div>
                      <div className="text-xs text-gray-600 mt-1">{decision.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Dynamic Form Fields Based on Decision */}
              <div className="space-y-4">
                {/* Task Title - for most decisions */}
                {['DO', 'DEFER', 'DELEGATE', 'PROJECT'].includes(gtdDecision) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìù Tytu≈Ç zadania
                    </label>
                    <input
                      type="text"
                      value={gtdTaskTitle}
                      onChange={(e) => setGTDTaskTitle(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      placeholder="Opisz zadanie..."
                    />
                  </div>
                )}

                {/* Context - for actionable items */}
                {['DO', 'DEFER', 'DELEGATE'].includes(gtdDecision) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìç Kontekst
                    </label>
                    <select
                      value={gtdContext}
                      onChange={(e) => setGTDContext(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="@computer">üíª @computer</option>
                      <option value="@calls">üìû @calls</option>
                      <option value="@office">üè¢ @office</option>
                      <option value="@home">üè† @home</option>
                      <option value="@errands">üöó @errands</option>
                      <option value="@online">üåê @online</option>
                      <option value="@waiting">‚è≥ @waiting</option>
                      <option value="@reading">üìñ @reading</option>
                    </select>
                  </div>
                )}

                {/* Priority */}
                {['DO', 'DEFER', 'DELEGATE'].includes(gtdDecision) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üéØ Priorytet
                    </label>
                    <div className="flex space-x-3">
                      {[
                        { value: 'LOW', label: 'üîµ Niski', color: 'border-blue-200 hover:bg-blue-50' },
                        { value: 'MEDIUM', label: 'üü° ≈öredni', color: 'border-yellow-200 hover:bg-yellow-50' },
                        { value: 'HIGH', label: 'üî¥ Wysoki', color: 'border-red-200 hover:bg-red-50' },
                      ].map((priority) => (
                        <button
                          key={priority.value}
                          onClick={() => setGTDPriority(priority.value as any)}
                          className={`flex-1 p-2 border-2 rounded-md text-sm font-medium transition-all ${
                            gtdPriority === priority.value
                              ? 'border-blue-500 bg-blue-50'
                              : priority.color
                          }`}
                        >
                          {priority.label}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Due Date - for DEFER and DELEGATE */}
                {['DEFER', 'DELEGATE'].includes(gtdDecision) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìÖ Data wykonania
                    </label>
                    <input
                      type="date"
                      value={gtdDueDate}
                      onChange={(e) => setGTDDueDate(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      min={new Date().toISOString().split('T')[0]}
                    />
                  </div>
                )}

                {/* Delegate User - for DELEGATE */}
                {gtdDecision === 'DELEGATE' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üë§ Przypisz do
                    </label>
                    <input
                      type="text"
                      value={gtdDelegateUser}
                      onChange={(e) => setGTDDelegateUser(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      placeholder="ID u≈ºytkownika lub email..."
                    />
                  </div>
                )}

                {/* Project Title - for PROJECT */}
                {gtdDecision === 'PROJECT' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìÅ Nazwa projektu
                    </label>
                    <input
                      type="text"
                      value={gtdProjectTitle}
                      onChange={(e) => setGTDProjectTitle(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      placeholder="Opisz projekt..."
                    />
                  </div>
                )}

                {/* Project Description */}
                {gtdDecision === 'PROJECT' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìã Opis projektu
                    </label>
                    <textarea
                      value={gtdProjectDescription}
                      onChange={(e) => setGTDProjectDescription(e.target.value)}
                      rows={2}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      placeholder="Szczeg√≥≈Çowy opis projektu..."
                    />
                  </div>
                )}

                {/* Project Priority & Status */}
                {gtdDecision === 'PROJECT' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üéØ Priorytet projektu
                      </label>
                      <select
                        value={gtdProjectPriority}
                        onChange={(e) => setGTDProjectPriority(e.target.value as any)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="LOW">üîµ Niski</option>
                        <option value="MEDIUM">üü° ≈öredni</option>
                        <option value="HIGH">üî¥ Wysoki</option>
                        <option value="URGENT">üö® Pilny</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üìä Status projektu
                      </label>
                      <select
                        value={gtdProjectStatus}
                        onChange={(e) => setGTDProjectStatus(e.target.value as any)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="PLANNING">üìù Planowanie</option>
                        <option value="IN_PROGRESS">üöÄ W trakcie</option>
                        <option value="ON_HOLD">‚è∏Ô∏è Wstrzymany</option>
                        <option value="COMPLETED">‚úÖ Uko≈Ñczony</option>
                        <option value="CANCELED">‚ùå Anulowany</option>
                      </select>
                    </div>
                  </div>
                )}

                {/* Project Dates */}
                {gtdDecision === 'PROJECT' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üìÖ Data rozpoczƒôcia
                      </label>
                      <input
                        type="date"
                        value={gtdStartDate}
                        onChange={(e) => setGTDStartDate(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üèÅ Data zako≈Ñczenia
                      </label>
                      <input
                        type="date"
                        value={gtdEndDate}
                        onChange={(e) => setGTDEndDate(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        min={gtdStartDate || undefined}
                      />
                    </div>
                  </div>
                )}

                {/* Estimated Time - for actionable items */}
                {['DO', 'DEFER', 'DELEGATE'].includes(gtdDecision) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      ‚è∞ Szacowany czas (minuty)
                    </label>
                    <div className="flex space-x-2">
                      {[15, 30, 60, 120].map((time) => (
                        <button
                          key={time}
                          onClick={() => setGTDEstimatedTime(time)}
                          className={`px-3 py-2 border rounded-md text-sm transition-all ${
                            gtdEstimatedTime === time
                              ? 'border-blue-500 bg-blue-50 text-blue-700'
                              : 'border-gray-300 hover:border-gray-400'
                          }`}
                        >
                          {time}min
                        </button>
                      ))}
                      <input
                        type="number"
                        value={gtdEstimatedTime}
                        onChange={(e) => setGTDEstimatedTime(parseInt(e.target.value) || 30)}
                        className="w-20 p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500"
                        min="5"
                        max="480"
                      />
                    </div>
                  </div>
                )}

                {/* Poziom energii */}
                {['DO', 'DEFER', 'DELEGATE'].includes(gtdDecision) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      ‚ö° Poziom energii
                    </label>
                    <div className="flex space-x-3">
                      {[
                        { value: 'LOW', label: 'üîã Niski', color: 'border-gray-200 hover:bg-gray-50' },
                        { value: 'MEDIUM', label: 'üîãüîã ≈öredni', color: 'border-yellow-200 hover:bg-yellow-50' },
                        { value: 'HIGH', label: 'üîãüîãüîã Wysoki', color: 'border-green-200 hover:bg-green-50' },
                      ].map((energy) => (
                        <button
                          key={energy.value}
                          onClick={() => setGTDEnergyLevel(energy.value as any)}
                          className={`flex-1 p-2 border-2 rounded-md text-sm font-medium transition-all ${
                            gtdEnergyLevel === energy.value
                              ? 'border-blue-500 bg-blue-50'
                              : energy.color
                          }`}
                        >
                          {energy.label}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Czy czeka na kogo≈õ */}
                {['DO', 'DEFER', 'DELEGATE'].includes(gtdDecision) && (
                  <div>
                    <div className="flex items-center space-x-2 mb-2">
                      <input
                        type="checkbox"
                        id="gtdIsWaitingFor"
                        checked={gtdIsWaitingFor}
                        onChange={(e) => setGTDIsWaitingFor(e.target.checked)}
                        className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                      />
                      <label htmlFor="gtdIsWaitingFor" className="text-sm font-medium text-gray-700">
                        ‚è≥ Zadanie czeka na kogo≈õ/co≈õ
                      </label>
                    </div>
                    {gtdIsWaitingFor && (
                      <input
                        type="text"
                        value={gtdWaitingForNote}
                        onChange={(e) => setGTDWaitingForNote(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        placeholder="Na co czekasz? (np. odpowied≈∫ od klienta, dostawƒô, zatwierdzenie...)"
                      />
                    )}
                  </div>
                )}

                {/* Someday/Maybe Category */}
                {gtdDecision === 'SOMEDAY' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üåü Kategoria Someday/Maybe
                    </label>
                    <select
                      value={gtdSomedayCategory}
                      onChange={(e) => setGTDSomedayCategory(e.target.value as any)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="IDEAS">üí° Pomys≈Çy</option>
                      <option value="PROJECTS">üìÅ Projekty na przysz≈Ço≈õƒá</option>
                      <option value="GOALS">üéØ Cele</option>
                      <option value="LEARNING">üìö Nauka</option>
                      <option value="TRAVEL">‚úàÔ∏è Podr√≥≈ºe</option>
                      <option value="PURCHASES">üõí Zakupy</option>
                      <option value="EXPERIENCES">üé≠ Do≈õwiadczenia</option>
                    </select>
                  </div>
                )}

                {/* Someday Review Date */}
                {gtdDecision === 'SOMEDAY' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìÖ Kiedy przejrzeƒá? (opcjonalnie)
                    </label>
                    <input
                      type="date"
                      value={gtdSomedayWhenToReview}
                      onChange={(e) => setGTDSomedayWhenToReview(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      min={new Date().toISOString().split('T')[0]}
                    />
                  </div>
                )}

                {/* Reference Category & URL */}
                {gtdDecision === 'REFERENCE' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üìö Kategoria materia≈Çu
                      </label>
                      <input
                        type="text"
                        value={gtdReferenceCategory}
                        onChange={(e) => setGTDReferenceCategory(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        placeholder="np. Dokumentacja, Artyku≈Çy, Procedury..."
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üîó Link/URL (opcjonalnie)
                      </label>
                      <input
                        type="url"
                        value={gtdReferenceUrl}
                        onChange={(e) => setGTDReferenceUrl(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                        placeholder="https://..."
                      />
                    </div>
                  </div>
                )}

                {/* Additional Note */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    üìù Dodatkowe notatki (opcjonalnie)
                  </label>
                  <textarea
                    value={gtdNote}
                    onChange={(e) => setGTDNote(e.target.value)}
                    rows={3}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    placeholder="Dodatkowe informacje, kontekst, linki..."
                  />
                </div>
              </div>
            </div>

            {/* Modal Footer */}
            <div className="px-6 py-4 border-t border-gray-200 bg-gray-50">
              <div className="flex items-center justify-between">
                <div className="text-sm text-gray-600">
                  üéØ Metodologia GTD - {gtdDecision === 'DO' ? 'Zr√≥b natychmiast' : 
                    gtdDecision === 'DEFER' ? 'Zaplanuj na p√≥≈∫niej' :
                    gtdDecision === 'DELEGATE' ? 'Przypisz komu≈õ' :
                    gtdDecision === 'PROJECT' ? 'Wymaga wielu krok√≥w' :
                    gtdDecision === 'REFERENCE' ? 'Zachowaj jako materia≈Ç' :
                    gtdDecision === 'SOMEDAY' ? 'Mo≈ºe kiedy≈õ' : 'Usu≈Ñ bez ≈õladu'}
                </div>
                
                <div className="flex items-center space-x-3">
                  <button
                    onClick={handleGTDCancel}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                  >
                    Anuluj
                  </button>
                  <button
                    onClick={handleGTDSave}
                    className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
                    disabled={
                      (gtdDecision === 'PROJECT' && !gtdProjectTitle) ||
                      (['DO', 'DEFER', 'DELEGATE'].includes(gtdDecision) && !gtdTaskTitle) ||
                      (gtdDecision === 'DELEGATE' && !gtdDelegateUser)
                    }
                  >
                    üíæ Zapisz {gtdDecision}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Quick Email Filter Modal */}
      {showQuickFilterModal && quickFilterMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-full max-w-lg">
            <h2 className="text-xl font-bold mb-4">üéØ Szybki Filtr Email</h2>
            
            <div className="mb-4 p-4 bg-gray-50 rounded-md">
              <h3 className="font-semibold text-sm text-gray-700">Email do kategoryzacji:</h3>
              <p className="text-sm text-gray-600 mt-1">
                <strong>Od:</strong> {quickFilterMessage.fromAddress} 
                {quickFilterMessage.fromName && ` (${quickFilterMessage.fromName})`}
              </p>
              <p className="text-sm text-gray-600">
                <strong>Temat:</strong> {quickFilterMessage.subject || 'Brak tematu'}
              </p>
              <p className="text-sm text-gray-600">
                <strong>Domena:</strong> {quickFilterMessage.fromAddress.split('@')[1] || 'Nieznana'}
              </p>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Kategoria Email</label>
                <select
                  value={quickFilterCategory}
                  onChange={(e) => setQuickFilterCategory(e.target.value as EmailCategory)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
                >
                  <option value="VIP">‚≠ê VIP - Wa≈ºni kontakty (pe≈Çna analiza AI)</option>
                  <option value="SPAM">üóëÔ∏è SPAM - Niechciane (pomi≈Ñ AI, usu≈Ñ)</option>
                  <option value="INVOICES">üìÑ INVOICES - Faktury (pomi≈Ñ AI, utw√≥rz zadanie)</option>
                  <option value="ARCHIVE">üìÅ ARCHIVE - Archiwum (pomi≈Ñ AI, archiwizuj)</option>
                  <option value="UNKNOWN">‚ùì UNKNOWN - Nieznane (analizuj z AI)</option>
                </select>
              </div>

              <div className="flex items-start space-x-3">
                <input
                  type="checkbox"
                  id="createRule"
                  checked={quickFilterCreateRule}
                  onChange={(e) => setQuickFilterCreateRule(e.target.checked)}
                  className="mt-1"
                />
                <div className="flex-1">
                  <label htmlFor="createRule" className="text-sm font-medium text-gray-700 cursor-pointer">
                    Utw√≥rz regu≈Çƒô filtrowania dla tej domeny
                  </label>
                  <p className="text-xs text-gray-500 mt-1">
                    Automatycznie kategoryzuj przysz≈Çe emaile z domeny: {quickFilterMessage.fromAddress.split('@')[1]}
                  </p>
                </div>
              </div>

              {quickFilterCreateRule && (
                <div>
                  <label className="block text-sm font-medium mb-2">Nazwa regu≈Çy</label>
                  <input
                    type="text"
                    value={quickFilterRuleName}
                    onChange={(e) => setQuickFilterRuleName(e.target.value)}
                    placeholder={`Filtr ${quickFilterCategory} dla ${quickFilterMessage.fromAddress.split('@')[1]}`}
                    className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              )}

              <div className="p-3 bg-blue-50 rounded-md">
                <h4 className="text-sm font-semibold text-blue-800 mb-2">Efekt kategoryzacji:</h4>
                <div className="space-y-1 text-xs text-blue-700">
                  {quickFilterCategory === 'VIP' && (
                    <>
                      <div>‚úÖ Pe≈Çna analiza AI</div>
                      <div>‚úÖ Utworzenie zadania przy wa≈ºnych wiadomo≈õciach</div>
                      <div>üí∞ Redukcja koszt√≥w: 0% (pe≈Çna analiza)</div>
                    </>
                  )}
                  {quickFilterCategory === 'SPAM' && (
                    <>
                      <div>üö´ Pominiƒôcie analizy AI</div>
                      <div>üóëÔ∏è Automatyczne usuwanie</div>
                      <div>üí∞ Redukcja koszt√≥w: 95%</div>
                    </>
                  )}
                  {quickFilterCategory === 'INVOICES' && (
                    <>
                      <div>üö´ Pominiƒôcie analizy AI</div>
                      <div>üìÅ Automatyczna archiwizacja</div>
                      <div>‚úÖ Utworzenie zadania ksiƒôgowego</div>
                      <div>üí∞ Redukcja koszt√≥w: 85%</div>
                    </>
                  )}
                  {quickFilterCategory === 'ARCHIVE' && (
                    <>
                      <div>üö´ Pominiƒôcie analizy AI</div>
                      <div>üìÅ Automatyczna archiwizacja</div>
                      <div>üí∞ Redukcja koszt√≥w: 90%</div>
                    </>
                  )}
                  {quickFilterCategory === 'UNKNOWN' && (
                    <>
                      <div>ü§ñ Analiza AI dla kategoryzacji</div>
                      <div>üí∞ Redukcja koszt√≥w: 0% (pierwsza analiza)</div>
                    </>
                  )}
                </div>
              </div>
            </div>

            <div className="flex justify-end space-x-3 mt-6">
              <button
                onClick={handleQuickFilterCancel}
                className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
              >
                Anuluj
              </button>
              <button
                onClick={handleQuickFilterSave}
                className={`px-4 py-2 text-white rounded-md hover:opacity-90 ${getCategoryColor(quickFilterCategory).includes('purple') ? 'bg-purple-600' :
                  getCategoryColor(quickFilterCategory).includes('red') ? 'bg-red-600' :
                  getCategoryColor(quickFilterCategory).includes('blue') ? 'bg-blue-600' :
                  getCategoryColor(quickFilterCategory).includes('gray') ? 'bg-gray-600' : 'bg-yellow-600'
                }`}
              >
                {getCategoryIcon(quickFilterCategory)} Kategoryzuj jako {quickFilterCategory}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}