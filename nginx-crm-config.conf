# Nginx configuration for CRM-GTD application under /crm directory
# This configuration should be included in your main nginx config

# V1 Frontend - serve under /crm path
location /crm {
    # Remove trailing slash to handle both /crm and /crm/
    location = /crm {
        return 301 /crm/;
    }
    
    # Proxy to frontend container - preserving the /crm prefix
    proxy_pass http://localhost:9025/crm;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /crm;
    proxy_cache_bypass $http_upgrade;
    
    # Ensure proper handling of Next.js static assets
    proxy_set_header Accept-Encoding "";
    
    # Handle Next.js hot reload and websocket connections
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
}

# V1 API - proxy /crm/api requests to backend
location /crm/api/ {
    # Rewrite /crm/api/v1/... to /api/v1/...
    rewrite ^/crm/api(.*)$ /api$1 break;
    
    # Proxy to backend container
    proxy_pass http://localhost:3003;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /crm;
    
    # Handle CORS preflight requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Content-Length' 0;
        return 204;
    }
}

# V2 Frontend - serve under /crm2 path (when V2 is fixed)
location /crm2 {
    location = /crm2 {
        return 301 /crm2/;
    }
    
    proxy_pass http://localhost:9026/crm2;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /crm2;
    proxy_cache_bypass $http_upgrade;
    
    proxy_set_header Accept-Encoding "";
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
}

# V2 API - proxy /crm2/api requests to V2 backend (when V2 is fixed)
location /crm2/api/ {
    rewrite ^/crm2/api(.*)$ /api$1 break;
    
    proxy_pass http://localhost:3002;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /crm2;
    
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Content-Length' 0;
        return 204;
    }
}