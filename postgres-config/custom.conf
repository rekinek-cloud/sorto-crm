# PostgreSQL Optimization for 7.6GB RAM / 4 CPU Server
# Optimized for CRM-GTD Smart application

# Network Configuration
listen_addresses = '*'                    # Listen on all interfaces

# Memory Configuration
shared_buffers = 256MB                    # 25% of RAM for 1GB limit
effective_cache_size = 512MB              # PostgreSQL + OS cache
work_mem = 8MB                           # Per-query working memory
maintenance_work_mem = 64MB              # Maintenance operations
temp_buffers = 32MB                      # Temporary table buffers

# Connection Settings
max_connections = 50                     # Reduced for better resource management
idle_in_transaction_session_timeout = 300000  # 5 minutes

# Performance Tuning
checkpoint_completion_target = 0.9       # Spread checkpoints
wal_buffers = 16MB                      # WAL buffer size
checkpoint_timeout = 10min              # Checkpoint frequency
max_wal_size = 512MB                    # Maximum WAL size
min_wal_size = 80MB                     # Minimum WAL size

# Query Planning
random_page_cost = 1.1                  # SSD-optimized
effective_io_concurrency = 200          # Concurrent I/O operations
seq_page_cost = 1.0                     # Sequential read cost

# Parallel Query
max_worker_processes = 4                # Match CPU cores
max_parallel_workers_per_gather = 2     # Parallel workers per query
max_parallel_workers = 4                # Total parallel workers
max_parallel_maintenance_workers = 2    # Maintenance parallel workers

# Statistics and Logging
shared_preload_libraries = 'pg_stat_statements'
log_min_duration_statement = 1000       # Log slow queries (1s+)
log_checkpoints = on                    # Log checkpoint activity
log_connections = off                   # Reduce log noise
log_disconnections = off                # Reduce log noise
log_lock_waits = on                     # Log lock waits

# Vacuum and Analyze
autovacuum = on                         # Enable autovacuum
autovacuum_max_workers = 2              # Autovacuum workers
autovacuum_naptime = 30s                # Autovacuum frequency
autovacuum_vacuum_scale_factor = 0.1    # Vacuum when 10% changed
autovacuum_analyze_scale_factor = 0.05  # Analyze when 5% changed

# Background Writer
bgwriter_delay = 200ms                  # Background writer delay
bgwriter_lru_maxpages = 100            # Pages per round
bgwriter_lru_multiplier = 2.0          # Multiple of recent usage

# Archive and Replication (disabled for development)
archive_mode = off                      # No archiving needed
wal_level = replica                     # Minimal WAL level

# Lock Management
deadlock_timeout = 1s                   # Deadlock detection timeout
lock_timeout = 30s                      # Lock acquisition timeout

# Client Connection Defaults
default_transaction_isolation = 'read committed'
statement_timeout = 30s                 # Query timeout
tcp_keepalives_idle = 600              # TCP keepalive
tcp_keepalives_interval = 30           # TCP keepalive interval
tcp_keepalives_count = 3               # TCP keepalive count